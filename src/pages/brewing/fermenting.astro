---
import Base from '../../layouts/Base.astro'
import Navigation from '../../components/Navigation.astro'

// Real data from Maeon Craft Oracle (ψ/memory/recipes/citra-pale-ale.md)
// Timeline traced from LINE chat + Oracle retrospective
const batch = {
  id: "citra-pale-ale",
  name: "Citra Pale Ale",
  style: "American Pale Ale",
  brewDate: "2026-01-31",
  og: "1.051",
  targetFg: "1.010",
  abv: "5.5%",
  ibu: "35",
  volume: "25L",
  system: "Hopcat 65L",
  yeast: "Safale US-05",
  brewer: "Toto (โตโต้)",
  team: ["Toto (โตโต้)", "Nat (นัท)", "Oracle"],
  fermentationSchedule: {
    day0: "Pitch US-05 @ 18°C — OG 1.051 confirmed ✅",
    day1_3: "Active fermentation @ 18°C — CO2 bubbling, krausen forming",
    day7: "Mid-fermentation — peak activity expected",
    day10: "Gravity check — approaching target FG 1.010",
    day14: "Final gravity check — if stable, fermentation complete",
    package: "Cold crash → keg or bottle → carbonate 2.4 CO2-vol"
  }
};

// Real timeline events from Oracle data
const timeline = [
  { date: "2026-01-27", time: "11:08", event: "Nat asks workshop date in LINE group" },
  { date: "2026-01-27", time: "11:18", event: "Toto confirms: เสาร์นี้ครับอาจารย์ (this Saturday)" },
  { date: "2026-01-29", time: "21:23", event: "Toto: ต้นเบียร์เริ่ม 9.30 วันเสาร์ (brew starts 9:30 Saturday)" },
  { date: "2026-01-31", time: "09:30", event: "Brew day starts — mash in on Hopcat 65L" },
  { date: "2026-01-31", time: "~10:30", event: "Mash complete (65°C × 60min), mash out 75°C × 10min" },
  { date: "2026-01-31", time: "~11:00", event: "Sparge (11.08L @ 75-78°C)" },
  { date: "2026-01-31", time: "~12:00", event: "Boil starts — 8.2g Citra @ 60min" },
  { date: "2026-01-31", time: "~12:30", event: "7.3g Citra @ 30min" },
  { date: "2026-01-31", time: "~13:00", event: "Flame out — no 0min hop, lowered temp instead" },
  { date: "2026-01-31", time: "~13:10", event: "Whirlpool — 120g Citra @ 65-70°C × 10min (all aroma hops here)" },
  { date: "2026-01-31", time: "~14:30", event: "Chill to 18-20°C, transfer to fermenter" },
  { date: "2026-01-31", time: "15:00", event: "US-05 yeast pitched — fermentation begins" },
  { date: "2026-01-31", time: "21:00", event: "Oracle session: Toto asks about Sabro (coconut) hops" },
  { date: "2026-01-31", time: "21:35", event: "Toto sends hydrometer photo — OG 1.051 confirmed ✅" },
];

// Calculated fermentation milestones
const milestones = [
  { day: 0, date: "2026-01-31", status: "done", label: "Brew day + pitch", detail: "OG 1.051 — Toto's first Citra batch" },
  { day: 7, date: "2026-02-07", status: "active", label: "Mid-fermentation", detail: "Day 7 — peak activity, yeast working hard" },
  { day: 10, date: "2026-02-10", status: "upcoming", label: "FG check", detail: "Gravity reading — approaching 1.010?" },
  { day: 14, date: "2026-02-14", status: "upcoming", label: "Fermentation complete", detail: "Final gravity stable → ready for packaging" },
];

const milestoneColors: Record<string, string> = {
  "done": "bg-forest/20 text-forest-light border-forest/30",
  "active": "bg-amber/20 text-amber border-amber/30",
  "upcoming": "bg-stone/10 text-stone-muted border-stone/20",
};
---

<Base title="Fermenting: Citra Pale Ale — Maeon Craft Oracle">
  <Navigation currentPage="fermenting" />
  <main class="relative pt-24 pb-16 min-h-screen">
    <div class="mx-auto max-w-5xl px-4 md:px-6 lg:px-8">

      <!-- Breadcrumb -->
      <div class="mb-8">
        <a href="/" class="text-stone-muted hover:text-amber text-sm transition-colors cursor-pointer">&larr; Back to Home</a>
        <span class="text-stone-muted/40 mx-2">/</span>
        <a href="/brewing/recipes" class="text-stone-muted hover:text-amber text-sm transition-colors cursor-pointer">Recipes</a>
      </div>

      <!-- Header -->
      <div class="mb-12">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-3 h-3 bg-forest-light rounded-full gentle-pulse"></div>
          <p class="text-forest-light text-sm font-medium tracking-widest">LIVE FERMENTATION</p>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4" style="font-family: 'Inter', sans-serif;">
          {batch.name}
        </h1>
        <p class="text-stone text-lg" style="font-family: 'Sarabun', sans-serif;">
          {batch.style} &bull; {batch.volume} &bull; {batch.yeast} &bull; Brewer: {batch.brewer}
        </p>
      </div>

      <!-- Live Counter + Stats -->
      <div class="grid md:grid-cols-2 gap-6 mb-12">
        <!-- Day Counter -->
        <div class="glass rounded-2xl p-8 flex flex-col items-center justify-center border border-forest/20" id="live-counter-box" data-brew-date={batch.brewDate}>
          <p id="current-day" class="text-7xl md:text-8xl font-black text-forest-light tabular-nums" style="font-family: 'Inter', sans-serif;">—</p>
          <p class="text-forest-light/60 text-lg font-medium tracking-widest mt-1">DAYS</p>
          <div class="mt-4 flex gap-3 text-center">
            <div>
              <p id="live-hours" class="text-2xl font-bold text-forest-light tabular-nums">--</p>
              <p class="text-forest-light/40 text-xs">HRS</p>
            </div>
            <p class="text-forest-light/20 text-2xl">:</p>
            <div>
              <p id="live-mins" class="text-2xl font-bold text-forest-light tabular-nums">--</p>
              <p class="text-forest-light/40 text-xs">MIN</p>
            </div>
            <p class="text-forest-light/20 text-2xl">:</p>
            <div>
              <p id="live-secs" class="text-2xl font-bold text-amber tabular-nums">--</p>
              <p class="text-amber/40 text-xs">SEC</p>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-3">
          <div class="glass-amber rounded-xl p-4 text-center flex flex-col justify-center">
            <p class="text-2xl font-mono text-amber">{batch.og}</p>
            <p class="text-stone-muted text-xs mt-1">OG</p>
          </div>
          <div class="glass-amber rounded-xl p-4 text-center flex flex-col justify-center">
            <p class="text-2xl font-mono text-stone-muted">{batch.targetFg}</p>
            <p class="text-stone-muted text-xs mt-1">Target FG</p>
          </div>
          <div class="glass-amber rounded-xl p-4 text-center flex flex-col justify-center">
            <p class="text-2xl font-mono text-amber">{batch.abv}</p>
            <p class="text-stone-muted text-xs mt-1">Est. ABV</p>
          </div>
          <div class="glass-amber rounded-xl p-4 text-center flex flex-col justify-center">
            <p class="text-2xl font-mono text-stone">{batch.ibu}</p>
            <p class="text-stone-muted text-xs mt-1">IBU</p>
          </div>
          <div class="glass-amber rounded-xl p-4 text-center flex flex-col justify-center">
            <p class="text-2xl font-mono text-stone">{batch.volume}</p>
            <p class="text-stone-muted text-xs mt-1">Batch</p>
          </div>
          <div class="glass-amber rounded-xl p-4 text-center flex flex-col justify-center">
            <p class="text-lg font-mono text-stone">{batch.system}</p>
            <p class="text-stone-muted text-xs mt-1">System</p>
          </div>
        </div>
      </div>

      <!-- Fermentation Milestones -->
      <div class="mb-12">
        <h2 class="text-xl font-bold text-white mb-6" style="font-family: 'Inter', sans-serif;">Fermentation Milestones</h2>
        <div class="space-y-3">
          {milestones.map((m) => (
            <div class="glass rounded-xl p-5 flex items-center gap-5">
              <span class:list={["px-3 py-1.5 text-xs rounded-full border font-mono shrink-0", milestoneColors[m.status]]}>
                Day {m.day}
              </span>
              <div class="flex-1">
                <p class="text-white font-medium" style="font-family: 'Inter', sans-serif;">{m.label}</p>
                <p class="text-stone-muted text-sm" style="font-family: 'Sarabun', sans-serif;">{m.detail}</p>
              </div>
              <p class="text-stone-muted text-xs shrink-0">{m.date}</p>
            </div>
          ))}
        </div>
      </div>

      <!-- Fermentation Schedule -->
      <div class="mb-12">
        <h2 class="text-xl font-bold text-white mb-6" style="font-family: 'Inter', sans-serif;">Fermentation Schedule</h2>
        <div class="glass rounded-2xl p-6 space-y-4">
          {Object.entries(batch.fermentationSchedule).map(([day, detail]) => (
            <div class="flex items-start gap-4">
              <span class="px-3 py-1 bg-amber/10 text-amber text-xs rounded-full shrink-0 font-mono">{day}</span>
              <p class="text-stone text-sm" style="font-family: 'Sarabun', sans-serif;">{detail}</p>
            </div>
          ))}
        </div>
      </div>

      <!-- Brew Day Timeline -->
      <div class="mb-12">
        <h2 class="text-xl font-bold text-white mb-6" style="font-family: 'Inter', sans-serif;">Brew Day Timeline</h2>
        <p class="text-stone-muted text-sm mb-4" style="font-family: 'Sarabun', sans-serif;">
          Traced from LINE chat + Oracle retrospective — ข้อมูลจริงจาก Oracle memory
        </p>
        <div class="glass rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-forest/20">
                  <th class="text-left p-4 text-forest-light font-medium">Date</th>
                  <th class="text-left p-4 text-forest-light font-medium">Time</th>
                  <th class="text-left p-4 text-forest-light font-medium">Event</th>
                </tr>
              </thead>
              <tbody>
                {timeline.map((t) => (
                  <tr class="border-b border-forest/10 hover:bg-forest/5 transition-colors">
                    <td class="p-4 font-mono text-stone-muted text-xs whitespace-nowrap">{t.date}</td>
                    <td class="p-4 font-mono text-amber text-xs whitespace-nowrap">{t.time}</td>
                    <td class="p-4 text-stone" style="font-family: 'Sarabun', sans-serif;">{t.event}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Data Source -->
      <div class="mb-8 p-6 bg-forest/10 border border-forest/20 rounded-xl">
        <p class="text-forest-light text-sm" style="font-family: 'Sarabun', sans-serif;">
          ข้อมูลจริงจาก Oracle memory — ψ/memory/recipes/citra-pale-ale.md + ψ/archive/line-chat/ + retrospective
        </p>
      </div>

      <!-- Team -->
      <div class="text-center">
        <p class="text-stone-muted text-sm">
          Team: {batch.team.join(" & ")}
        </p>
      </div>

    </div>
  </main>

  <script>
    const box = document.getElementById('live-counter-box');
    const brewDateStr = box?.dataset.brewDate;

    const update = () => {
      if (!brewDateStr) return;
      const brew = new Date(brewDateStr + 'T15:00:00+07:00');
      const now = new Date();
      const diffMs = now.getTime() - brew.getTime();
      const totalSecs = Math.max(0, Math.floor(diffMs / 1000));
      const days = Math.floor(totalSecs / 86400);
      const rem = totalSecs % 86400;
      const hrs = Math.floor(rem / 3600);
      const mins = Math.floor((rem % 3600) / 60);
      const secs = rem % 60;
      const pad = (n: number) => n.toString().padStart(2, '0');

      const dayEl = document.getElementById('current-day');
      const hrsEl = document.getElementById('live-hours');
      const minsEl = document.getElementById('live-mins');
      const secsEl = document.getElementById('live-secs');

      if (dayEl) dayEl.textContent = `${days}`;
      if (hrsEl) hrsEl.textContent = pad(hrs);
      if (minsEl) minsEl.textContent = pad(mins);
      if (secsEl) secsEl.textContent = pad(secs);
    };

    update();
    setInterval(update, 1000);
  </script>
</Base>
